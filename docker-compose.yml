version: "3.8"

services:
  restic-backup:
    image: mazzolino/restic:1.8
    restart: unless-stopped
    container_name: resticBackup-${RESTIC_BACKUP_HOST}
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:?Missing environment variable see readme}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:?Missing environment variable see readme}
      BACKUP_CRON: ${RESTIC_BACKUP_CRON-"0 30 3 * * *"}
      POST_COMMANDS_EXIT: if [ -f /tmp/stopped_containers.txt ] && [ -s /tmp/stopped_containers.txt ]; then docker start $$(cat /tmp/stopped_containers.txt); rm -f /tmp/stopped_containers.txt; fi
      POST_COMMANDS_FAILURE: |-
        curl -s -X POST --data "{\"title\": \"Backup failed\", \"body\": \"Backup failed for ${RESTIC_BACKUP_HOST:?Missing environment variable see readme} with tag ${RESTIC_BACKUP_TAG-docker-volumes}\"}" http://notify:5000
      POST_COMMANDS_INCOMPLETE: |-
        curl -s -X POST --data "{\"title\": \"Backup incomplete\", \"body\": \"Backup incomplete for ${RESTIC_BACKUP_HOST:?Missing environment variable see readme} with tag ${RESTIC_BACKUP_TAG-docker-volumes}\"}" http://notify:5000
      POST_COMMANDS_SUCCESS: |-
        curl -s -X POST --data "{\"title\": \"Backup completed\", \"body\": \"Backup completed for ${RESTIC_BACKUP_HOST:?Missing environment variable see readme} with tag ${RESTIC_BACKUP_TAG-docker-volumes}\"}" http://notify:5000
      PRE_COMMANDS: docker ps --filter "status=running" --format "{{.ID}} {{.Names}}" | grep -vE "restic|notify" | awk '{print $$1}' > /tmp/stopped_containers.txt; if [ -s /tmp/stopped_containers.txt ]; then docker stop $$(cat /tmp/stopped_containers.txt); fi
      RESTIC_BACKUP_ARGS: >-
        --tag ${RESTIC_BACKUP_TAG-docker-volumes}
        --host ${RESTIC_BACKUP_HOST:?Missing environment variable see readme}
        --exclude *.tmp
        --verbose
      RESTIC_BACKUP_SOURCES: /mnt/volumes
      RESTIC_FORGET_ARGS: >-
        --keep-last ${RESTIC_KEEP_LAST-30}
        --keep-daily ${RESTIC_KEEP_DAILY-7}
        --keep-weekly ${RESTIC_KEEP_WEEKLY-5}
        --keep-monthly ${RESTIC_KEEP_MONTHLY-12}
      RESTIC_PASSWORD: ${RESTIC_PASSWORD:?Missing environment variable see readme}
      RESTIC_REPOSITORY: ${RESTIC_REPOSITORY:?Missing environment variable see readme}
      RUN_ON_STARTUP: "true"
      TZ: ${RESTIC_TZ-Europe/Berlin}
    volumes:
      - /var/lib/docker/volumes:/mnt/volumes:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    depends_on:
      - notify

  restic-prune:
    image: mazzolino/restic:1.8
    container_name: resticPrune-${RESTIC_BACKUP_HOST}
    restart: unless-stopped
    profiles:
      - prune
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:?Missing environment variable see readme}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:?Missing environment variable see readme}
      POST_COMMANDS_FAILURE: |-
        curl -s -X POST --data "{\"title\": \"Prune failed\", \"body\": \"Prune failed for ${RESTIC_BACKUP_HOST:?Missing environment variable see readme} with tag ${RESTIC_BACKUP_TAG-docker-volumes}\"}" http://notify:5000
      PRUNE_CRON: ${RESTIC_PRUNE_CRON-"0 0 4 * * *"}
      RESTIC_PASSWORD: ${RESTIC_PASSWORD:?Missing environment variable see readme}
      RESTIC_REPOSITORY: ${RESTIC_REPOSITORY:?Missing environment variable see readme}
      RUN_ON_STARTUP: "false"
      SKIP_INIT: "true"
      TZ: ${RESTIC_TZ-Europe/Berlin}
    depends_on:
      - notify

  restic-check:
    image: mazzolino/restic:1.8
    container_name: resticCheck-${RESTIC_BACKUP_HOST}
    restart: unless-stopped
    profiles:
      - check
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:?Missing environment variable see readme}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:?Missing environment variable see readme}
      CHECK_CRON: ${RESTIC_CHECK_CRON-"0 15 5 * * *"}
      POST_COMMANDS_FAILURE: |-
        curl -s -X POST --data "{\"title\": \"Check failed\", \"body\": \"Check failed for ${RESTIC_BACKUP_HOST:?Missing environment variable see readme} with tag ${RESTIC_BACKUP_TAG-docker-volumes}\"}" http://notify:5000
      RESTIC_CHECK_ARGS: >-
        --read-data-subset=10%
      RESTIC_PASSWORD: ${RESTIC_PASSWORD:?Missing environment variable see readme}
      RESTIC_REPOSITORY: ${RESTIC_REPOSITORY:?Missing environment variable see readme}
      RUN_ON_STARTUP: "false"
      SKIP_INIT: "true"
      TZ: ${RESTIC_TZ-Europe/Berlin}
    depends_on:
      - notify

  notify:
    image: mazzolino/apprise-microservice:0.3
    container_name: notify-${RESTIC_BACKUP_HOST}
    restart: unless-stopped
    environment:
      NOTIFICATION_URLS: ${APPRISE_NOTIFICATION_URLS:?Missing environment variable see readme}
