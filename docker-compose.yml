version: "3.8"

services:
  restic-backup:
    image: mazzolino/restic:1.8
    restart: unless-stopped
    container_name: resticBackup-${RESTIC_BACKUP_HOST}
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:?Missing environment variable see readme}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:?Missing environment variable see readme}
      BACKUP_CRON: ${RESTIC_BACKUP_CRON-0 0 5 * * *}
      POST_COMMANDS_EXIT: if [ -n "$$STOPPED_CONTAINERS" ]; then docker start $$STOPPED_CONTAINERS; fi
      POST_COMMANDS_FAILURE: curl -fsS -m 10 --retry 3 -X POST "${HEALTHCHECKS_URL_BACKUP_FAIL:-}?rid=$$RID" || true
      POST_COMMANDS_INCOMPLETE: curl -fsS -m 10 --retry 3 -X POST "${HEALTHCHECKS_URL_BACKUP_INCOMPLETE:-}?rid=$$RID" || true
      POST_COMMANDS_SUCCESS: curl -fsS -m 10 --retry 3 -X POST "${HEALTHCHECKS_URL_BACKUP_SUCCESS:-}?rid=$$RID" || true
      PRE_COMMANDS: |-
        export RID=$$(cat /proc/sys/kernel/random/uuid 2>/dev/null || uuidgen 2>/dev/null || echo "")
        curl -fsS -m 10 --retry 3 -X POST "${HEALTHCHECKS_URL_BACKUP_START:-}?rid=$$RID" || true
        export STOPPED_CONTAINERS=$$(docker ps --filter "status=running" --format "{{.ID}} {{.Names}}" | grep -vE "restic" | awk '{print $$1}' | tr '\n' ' ' || echo "")
        if [ -n "$$STOPPED_CONTAINERS" ]; then docker stop $$STOPPED_CONTAINERS > /dev/null 2>&1 || true; fi
      RESTIC_BACKUP_ARGS: >-
        --tag ${RESTIC_BACKUP_TAG-docker-volumes}
        --host ${RESTIC_BACKUP_HOST:?Missing environment variable see readme}
        --exclude *.tmp
        --verbose
      RESTIC_BACKUP_SOURCES: /mnt/volumes
      RESTIC_FORGET_ARGS: >-
        --keep-last ${RESTIC_KEEP_LAST-30}
        --keep-daily ${RESTIC_KEEP_DAILY-7}
        --keep-weekly ${RESTIC_KEEP_WEEKLY-5}
        --keep-monthly ${RESTIC_KEEP_MONTHLY-12}
      RESTIC_PASSWORD: ${RESTIC_PASSWORD:?Missing environment variable see readme}
      RESTIC_REPOSITORY: ${RESTIC_REPOSITORY:?Missing environment variable see readme}
      RUN_ON_STARTUP: "true"
      TZ: ${RESTIC_TZ-Europe/Berlin}
    volumes:
      - /var/lib/docker/volumes:/mnt/volumes:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro

  restic-prune:
    image: mazzolino/restic:1.8
    container_name: resticPrune-${RESTIC_BACKUP_HOST}
    restart: unless-stopped
    profiles:
      - prune
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:?Missing environment variable see readme}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:?Missing environment variable see readme}
      POST_COMMANDS_FAILURE: curl -fsS -m 10 --retry 3 -X POST "${HEALTHCHECKS_URL_PRUNE_FAIL:-}?rid=$$RID" || true
      POST_COMMANDS_SUCCESS: curl -fsS -m 10 --retry 3 -X POST "${HEALTHCHECKS_URL_PRUNE_SUCCESS:-}?rid=$$RID" || true
      PRE_COMMANDS: |-
        export RID=$$(cat /proc/sys/kernel/random/uuid 2>/dev/null || uuidgen 2>/dev/null || echo "")
        curl -fsS -m 10 --retry 3 -X POST "${HEALTHCHECKS_URL_PRUNE_START:-}?rid=$$RID" || true
      PRUNE_CRON: ${RESTIC_PRUNE_CRON-0 0 6 * * *}
      RESTIC_PASSWORD: ${RESTIC_PASSWORD:?Missing environment variable see readme}
      RESTIC_REPOSITORY: ${RESTIC_REPOSITORY:?Missing environment variable see readme}
      RUN_ON_STARTUP: "false"
      SKIP_INIT: "true"
      TZ: ${RESTIC_TZ-Europe/Berlin}

  restic-check:
    image: mazzolino/restic:1.8
    container_name: resticCheck-${RESTIC_BACKUP_HOST}
    restart: unless-stopped
    profiles:
      - check
    environment:
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:?Missing environment variable see readme}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:?Missing environment variable see readme}
      CHECK_CRON: ${RESTIC_CHECK_CRON-0 0 7 * * *}
      POST_COMMANDS_FAILURE: curl -fsS -m 10 --retry 3 -X POST "${HEALTHCHECKS_URL_CHECK_FAIL:-}?rid=$$RID" || true
      POST_COMMANDS_SUCCESS: curl -fsS -m 10 --retry 3 -X POST "${HEALTHCHECKS_URL_CHECK_SUCCESS:-}?rid=$$RID" || true
      PRE_COMMANDS: |-
        export RID=$$(cat /proc/sys/kernel/random/uuid 2>/dev/null || uuidgen 2>/dev/null || echo "")
        curl -fsS -m 10 --retry 3 -X POST "${HEALTHCHECKS_URL_CHECK_START:-}?rid=$$RID" || true
      RESTIC_CHECK_ARGS: >-
        --read-data-subset=10%
      RESTIC_PASSWORD: ${RESTIC_PASSWORD:?Missing environment variable see readme}
      RESTIC_REPOSITORY: ${RESTIC_REPOSITORY:?Missing environment variable see readme}
      RUN_ON_STARTUP: "false"
      SKIP_INIT: "true"
      TZ: ${RESTIC_TZ-Europe/Berlin}
